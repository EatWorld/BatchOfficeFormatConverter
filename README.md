# Office旧格式批量转换工具 (DOC转DOCX, XLS转XLSX)

## 简介
本Python脚本旨在帮助用户批量将指定目录及其子目录下的旧版 Microsoft Office 文件（`.doc` 和 `.xls`）转换为现代格式（`.docx` 和 `.xlsx`）。转换成功后，新生成的文件会尝试保留原始文件的创建、访问和修改时间戳，而原始的旧格式文件将被移动到一个名为“旧格式文件”的子文件夹中进行归档。脚本能自动检测并跳过受密码保护的文件、Office应用程序认为存在问题的文件，并对文件占用导致的时间戳设置失败进行重试。

## 功能特性
1.  **格式转换**:
    *   Microsoft Word 文档: `.doc` 转换为 `.docx`
    *   Microsoft Excel 表格: `.xls` 转换为 `.xlsx`
2.  **时间戳保留 (尝试)**:
    *   转换后的新文件（`.docx`, `.xlsx`）将尝试继承原始文件（`.doc`, `.xls`）的创建时间、最后访问时间和最后修改时间。
    *   若设置时间戳时文件被占用，脚本会自动进行多次重试。
3.  **自动归档**:
    *   成功转换的原始 `.doc` 和 `.xls` 文件（或当新版格式已存在时）将被移动到源目录下一个名为 `旧格式文件` 的子文件夹中。
4.  **递归处理**:
    *   脚本会遍历指定目录及其所有子目录（不包括 `旧格式文件` 夹本身及其内部）。
5.  **智能错误处理与跳过**:
    *   自动检测并跳过受密码保护的 `.doc` 和 `.xls` 文件。
    *   自动跳过被 Microsoft Office 应用程序检测为“存在问题”或无法安全打开的文件。
    *   这些被跳过的文件将保留在原位，不会被转换或移动。
6.  **日志输出**:
    *   在控制台打印详细的操作日志，包括正在转换的文件、成功信息、警告（如文件占用、时间戳设置失败）、错误以及跳过的文件及其原因。
7.  **幂等性**:
    *   如果目标格式文件（如 `.docx`）已存在，则会跳过转换步骤，但原始的旧格式文件（`.doc`）仍会被移动到归档文件夹。

## 系统要求
*   **操作系统**: Windows (由于使用了 `win32com` 与 Microsoft Office 交互)
*   **Python版本**: Python 3.x
*   **依赖库**:
    *   `pywin32`: 用于与Windows COM对象（如Word和Excel应用程序）交互。
        *   安装命令: `pip install pywin32`
*   **软件**: **已安装并已激活的** Microsoft Office (Word 和 Excel 2007或更高版本，脚本依赖这些应用程序的功能)。**未激活的Office会导致脚本运行失败。**

## 使用方法
1.  **准备环境**:
    *   确保已安装 Python 3.x。
    *   安装 `pywin32` 库: 打开命令提示符或 PowerShell，运行 `pip install pywin32`。
    *   确保您的计算机上已安装并**激活** Microsoft Word 和 Microsoft Excel。
    *   **重要**: 建议将脚本运行的根目录添加到 Microsoft Office 的“受信任位置”（在Word/Excel的 文件 > 选项 > 信任中心 > 信任中心设置... > 受信任位置 中设置），以避免Office因安全策略阻止文件打开。
2.  **获取脚本**: 将提供的Python代码保存为文件（例如 `office_converter.py`）。
3.  **运行脚本**:
    *   **默认行为**: 将脚本文件 `office_converter.py` 放置在您想要处理文件的根目录中，然后通过命令行 `python office_converter.py` 执行。脚本将处理其所在目录下的所有文件。
        *   **建议**: 以管理员身份运行命令提示符或PowerShell (右键点击 -> 以管理员身份运行)，然后执行脚本，以避免文件移动时的权限问题。
    *   **指定目录 (可选)**: 如果您想处理其他目录，可以修改脚本末尾的 `source_dir` 变量。
4.  **查看结果**:
    *   转换后的 `.docx` 和 `.xlsx` 文件将出现在其原始文件所在的相同位置。
    *   原始的 `.doc` 和 `.xls` 文件（如果转换成功、新版已存在或满足移动条件）将被移动到该目录下自动创建的 `旧格式文件` 文件夹中。
    *   受密码保护、Office认为有问题或无法打开的文件将保留在原位。
    *   脚本运行过程中的详细信息和任何错误都将打印到控制台。

## 注意事项
*   在运行脚本之前，建议关闭所有 Microsoft Word 和 Excel 应用程序实例，以避免潜在的COM冲突。
*   脚本会修改文件系统（移动文件）。**强烈建议在对重要数据操作前进行备份。**
*   脚本不会处理以 `~` 开头的文件（通常是Office临时文件）。
*   如果脚本在处理大量文件时意外中断，部分文件可能已转换并移动。再次运行脚本通常是安全的。
*   时间戳的设置依赖于文件的写入权限和系统策略。如果文件被其他程序（如杀毒软件、同步服务）短暂占用，脚本会尝试几次；若持续占用，则时间戳可能无法设置。

## 常见问题与故障排除
*   **`NameError` 或 `ImportError: No module named 'win32com'`**:
    表示 `pywin32` 库未正确安装或Python环境配置问题。请尝试重新安装：`pip uninstall pywin32` 然后 `pip install pywin32`。有时可能需要以管理员权限运行命令提示符。
*   **脚本报错，提示COM错误，或Office应用弹出错误/对话框**:
    *   **首要检查**: 确保 Microsoft Office 已完全激活。未激活的Office是导致COM错误的主要原因。
    *   确保工作目录已添加到Office的“受信任位置”。
    *   确保运行脚本前已关闭所有Office程序实例。
    *   尝试修复Microsoft Office安装（控制面板 > 程序和功能 > Microsoft Office > 更改 > 修复）。
*   **移动文件失败，提示 `Permission denied`**:
    *   请以管理员身份运行脚本。
    *   确保没有其他程序（如文件浏览器预览、杀毒软件扫描）正在占用要移动的文件或目标文件夹。
*   **文件被跳过，提示“Office检测到此文件存在一个问题”**:
    *   这是Office的安全机制。将文件夹设为“受信任位置”通常能解决。如果不行，该文件可能确实存在Office无法处理的问题或损坏。

## 版本信息
*   脚本兼容 Python 3.x
*   依赖已激活的 Microsoft Office 2007 及以上版本
*   最后更新：增强了COM对象管理、错误处理细节，并为时间戳设置加入了重试机制。
